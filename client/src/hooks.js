import { useCallback, useContext, useEffect, useState } from "react";
import { httpAuthClient, httpClient } from "./http";
import { AuthContext } from "./contexts";


export const useAuthAPI = () => {
    const [user, setUser] = useState(null);
    const [authorizing, setAuthorizing] = useState(true);

    const login = async (credentials) => {
        const { data } = await httpClient.post('/auth/login', { user: credentials });
        setUser(data.user);
        localStorage.setItem('access_token', data.accessToken);
    }

    const signup = async (credentials) => {
        const { data } = await httpClient.post('/auth/signup', { user: credentials });
        setUser(data.user);
        localStorage.setItem('access_token', data.accessToken);
    }

    const authorize = useCallback(async () => {
        if (user) return;
        const { data } = await httpAuthClient.get('/auth/authorize');
        setUser(data.user);
    }, [user])

    const logout = () => {
        setUser(null);
        localStorage.removeItem('access_token');
    }

    useEffect(() => {
        if (!authorizing) return;
        authorize()
            .catch((err) => {
                console.error(err);
            })
            .finally(() => setAuthorizing(false))
    }, [authorizing, authorize])

    return {
        user,
        authenticated: !!user,
        authorizing,
        signup,
        login,
        authorize,
        logout
    }
}

export const useAuthContext = () => useContext(AuthContext);