const ex = require('express');
const { createUser, findUserByUsername, findUserById } = require('../services/user');
const { generateAccessToken } = require('../services/auth');
const { verifyAccessToken } = require('../middleware');

const authRouter = ex.Router();

authRouter.post('/signup', async (req, res, next) => {
    try {
        const user = await createUser(req.body.user);
        const accessToken = generateAccessToken(user.toJSON());
        res.status(201).send({ success: true, user, accessToken })
    } catch (err) {
        console.error(err);
        res.status(403);
        next(err.message)
    }
})

authRouter.post('/login', async (req, res, next) => {
    try {
        const user = await findUserByUsername(req.body.user.username);
        if (!user)
            throw Error('That user does not exist');
        if (!user.checkPassword(req.body.user.password))
            throw Error('Invalid password attempt');
        const accessToken = generateAccessToken(user.toJSON());
        res.status(200).send({ success: true, user, accessToken });

    } catch (err) {
        console.error(err);
        res.status(403);
        next(err.message);
    }
})

authRouter.get('/authorize', verifyAccessToken(), async (req, res, next) => {
    try {
        const user = await findUserById(req.auth._id);
        if(!user) throw Error('Unauthorized token')
        res.status(200).send({ user });
    } catch (err) {
        console.error(err);
        res.status(403);
        next(err.message);
    }
})

module.exports = {
    authRouter
}